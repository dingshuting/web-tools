steal("can/util",function(i){var c=i.isFunction,b=i.makeArray,e=1,h=i.view=i.template=function(k,p,o,q){if(c(o)){q=o;o=undefined}var n=function(r){return h.frag(r)},m=c(q)?function(r){q(n(r))}:null,j=h.render(k,p,o,m),l=i.Deferred();if(c(j)){return j}if(i.isDeferred(j)){j.then(function(r,s){l.resolve.call(l,n(r),s)},function(){l.fail.apply(l,arguments)});return l}return n(j)};i.extend(h,{frag:function(k,j){return h.hookup(h.fragment(k),j)},fragment:function(j){var k=i.buildFragment(j,document.body);if(!k.childNodes.length){k.appendChild(document.createTextNode(""))}return k},toId:function(j){return i.map(j.toString().split(/\/|\./g),function(k){if(k){return k}}).join("_")},hookup:function(k,j){var n=[],m,l;i.each(k.childNodes?i.makeArray(k.childNodes):k,function(o){if(o.nodeType===1){n.push(o);n.push.apply(n,i.makeArray(o.getElementsByTagName("*")))}});i.each(n,function(o){if(o.getAttribute&&(m=o.getAttribute("data-view-id"))&&(l=h.hookups[m])){l(o,j,m);delete h.hookups[m];o.removeAttribute("data-view-id")}});return k},hookups:{},hook:function(j){h.hookups[++e]=j;return" data-view-id='"+e+"'"},cached:{},cachedRenderers:{},cache:true,register:function(j){this.types["."+j.suffix]=j},types:{},ext:".ejs",registerScript:function(){},preload:function(){},render:function(p,o,j,q){if(c(j)){q=j;j=undefined}var s=g(o);if(s.length){var r=new i.Deferred(),k=i.extend({},o);s.push(d(p,true));i.when.apply(i,s).then(function(u){var w=b(arguments),v=w.pop(),t;if(i.isDeferred(o)){k=a(u)}else{for(var x in o){if(i.isDeferred(o[x])){k[x]=a(w.shift())}}}t=v(k,j);r.resolve(t,k);q&&q(t,k)},function(){r.reject.apply(r,arguments)});return r}else{var m,l=c(q),r=d(p,l);if(l){m=r;r.then(function(t){q(o?t(o,j):t)})}else{if(r.state()==="resolved"&&r.__view_id){var n=h.cachedRenderers[r.__view_id];return o?n(o,j):n}else{r.then(function(t){m=o?t(o,j):t})}}return m}},registerView:function(n,m,j,l){var k=(j||h.types[h.ext]).renderer(n,m);l=l||new i.Deferred();if(h.cache){h.cached[n]=l;l.__view_id=n;h.cachedRenderers[n]=k}return l.resolve(k)}});var f=function(k,j){if(!k.length){steal.dev.log("There is no template or an empty template at "+j);throw"can.view: No template or empty template:"+j}},d=function(k,n){var r=k.match(/\.[\w\d]+$/),p,m,l,q;if(k.match(/^#/)){k=k.substr(1)}if(m=document.getElementById(k)){r="."+m.type.match(/\/(x\-)?(.+)/)[2]}if(!r&&!h.cached[k]){k+=(r=h.ext)}if(i.isArray(r)){r=r[0]}l=h.toId(k);if(k.match(/^\/\//)){var j=k.substr(2);k=!window.steal?j:steal.config().root.mapJoin(""+steal.id(j))}p=h.types[r];if(h.cached[l]){return h.cached[l]}else{if(m){return h.registerView(l,m.innerHTML,p)}else{var o=new i.Deferred();i.ajax({async:n,url:k,dataType:"text",error:function(s){f("",k);o.reject(s)},success:function(s){f(s,k);h.registerView(l,s,p,o)}});return o}}},g=function(k){var j=[];if(i.isDeferred(k)){return[k]}else{for(var l in k){if(i.isDeferred(k[l])){j.push(k[l])}}}return j},a=function(j){return i.isArray(j)&&j[1]==="success"?j[0]:j};if(window.steal){steal.type("view js",function(k,m,j){var l=h.types["."+k.type],n=h.toId(k.id);k.text="steal('"+(l.plugin||"can/view/"+k.type)+"',function(can){return "+"can.view.preload('"+n+"',"+k.text+");\n})";m()})}i.extend(h,{register:function(j){this.types["."+j.suffix]=j;if(window.steal){steal.type(j.suffix+" view js",function(l,n,k){var m=h.types["."+l.type],o=h.toId(l.id+"");l.text=m.script(o,l.text);n()})}h[j.suffix]=function(m,l){if(!l){var k=function(){return h.frag(k.render.apply(this,arguments))};k.render=function(){var n=j.renderer(null,m);return n.apply(n,arguments)};return k}h.preload(m,j.renderer(m,l));return i.view(m)}},registerScript:function(j,l,k){return"can.view.preload('"+l+"',"+h.types["."+j].script(l,k)+");"},preload:function(m,k){var j=h.cached[m]=new i.Deferred().resolve(function(o,n){return k.call(o,o,n)});function l(){return h.frag(k.apply(this,arguments))}l.render=k;j.__view_id=m;h.cachedRenderers[m]=k;return l}});return i});