steal("can/util","can/observe",function(c){var q=function(a,b,e){var d=new c.Deferred;a.then(function(){var a=c.makeArray(arguments);try{a[0]=b[e](a[0]),d.resolveWith(d,a)}catch(g){d.rejectWith(d,[g].concat(a))}},function(){d.rejectWith(this,arguments)});"function"===typeof a.abort&&(d.abort=function(){return a.abort()});return d},r=0,l=function(a){c.Observe.__reading&&c.Observe.__reading(a,a.constructor.id);return a.__get(a.constructor.id)},m=function(a,b,e,d,f){var g;c.isArray(a)?(g=a[1],a=a[0]):
g=a.serialize();g=[g];var h=a.constructor,k;"destroy"==b&&g.shift();"create"!==b&&g.unshift(l(a));k=h[b].apply(h,g);g=k.pipe(function(c){a[f||b+"d"](c,k);return a});k.abort&&(g.abort=function(){k.abort()});g.then(e,d);return g},t={create:{url:"_shortName",type:"post"},update:{data:function(a,b){b=b||{};var e=this.id;b[e]&&b[e]!==a&&(b["new"+c.capitalize(a)]=b[e],delete b[e]);b[e]=a;return b},type:"put"},destroy:{type:"delete",data:function(a){var b={};b.id=b[this.id]=a;return b}},findAll:{url:"_shortName"},
findOne:{}},p=function(a,b){return function(e){e=a.data?a.data.apply(this,arguments):e;var d=b||this[a.url||"_url"],f=e,g=a.type||"get",h={};"string"==typeof d?(d=d.split(/\s+/),h.url=d.pop(),d.length&&(h.type=d.pop())):c.extend(h,d);h.data="object"!=typeof f||c.isArray(f)?f:c.extend(h.data||{},f);h.url=c.sub(h.url,h.data,!0);return c.ajax(c.extend({type:g||"post",dataType:"json",success:void 0,error:void 0},h))}};c.Model=c.Observe({fullName:"can.Model",_reqs:0,setup:function(a){this.store={};c.Observe.setup.apply(this,
arguments);if(c.Model){this.List=n({Observe:this},{});var b=this,e=c.proxy(this._clean,b);c.each(t,function(d,f){c.isFunction(b[f])||(b[f]=p(d,b[f]));if(b["make"+c.capitalize(f)]){var g=b["make"+c.capitalize(f)](b[f]);c.Construct._overwrite(b,a,f,function(){c.Model._reqs++;var a=g.apply(this,arguments),b=a.then(e,e);b.abort=a.abort;return b})}});"can.Model"!=b.fullName&&b.fullName||(b.fullName="Model"+ ++r);c.Model._reqs=0;this._url=this._shortName+"/{"+this.id+"}"}},_ajax:p,_makeRequest:m,_clean:function(a){c.Model._reqs--;
if(!c.Model._reqs)for(var b in this.store)this.store[b]._bindings||delete this.store[b];return a},models:function(a,b){c.Model._reqs++;if(a){if(a instanceof this.List)return a;var e=this,d=[],f=b instanceof c.Observe.List?b:new (e.List||n),g=c.isArray(a),h=a instanceof n,h=g?a:h?a.serialize():a.data;if("undefined"===typeof h)throw Error("Could not get any raw data while converting using .models");h.length||steal.dev.warn("model.js models has no data.");f.length&&f.splice(0);c.each(h,function(a){d.push(e.model(a))});
f.push.apply(f,d);g||c.each(a,function(a,b){"data"!==b&&f.attr(b,a)});setTimeout(c.proxy(this._clean,this),1);return f}},model:function(a){if(a){"function"===typeof a.serialize&&(a=a.serialize());var b=a[this.id],b=(b||0===b)&&this.store[b]?this.store[b].attr(a,this.removeAttr||!1):new this(a);c.Model._reqs&&(this.store[a[this.id]]=b);return b}}},{isNew:function(){var a=l(this);return!(a||0===a)},save:function(a,b){return m(this,this.isNew()?"create":"update",a,b)},destroy:function(a,b){if(this.isNew()){var e=
this,d=c.Deferred();d.then(a,b);return d.done(function(a){e.destroyed(a)}).resolve(e)}return m(this,"destroy",a,b,"destroyed")},_bindsetup:function(){this.constructor.store[this.__get(this.constructor.id)]=this;return c.Observe.prototype._bindsetup.apply(this,arguments)},_bindteardown:function(){delete this.constructor.store[l(this)];return c.Observe.prototype._bindteardown.apply(this,arguments)},___set:function(a,b){c.Observe.prototype.___set.call(this,a,b);a===this.constructor.id&&this._bindings&&
(this.constructor.store[l(this)]=this)}});c.each({makeFindAll:"models",makeFindOne:"model",makeCreate:"model",makeUpdate:"model"},function(a,b){c.Model[b]=function(b){return function(){var d=c.makeArray(arguments),f=c.isFunction(d[1])?d.splice(0,1):d.splice(0,2),f=q(b.apply(this,f),this,a);f.then(d[0],d[1]);return f}}});c.each(["created","updated","destroyed"],function(a){c.Model.prototype[a]=function(b){var e=this.constructor;b&&"object"==typeof b&&this.attr(b.attr?b.attr():b);c.trigger(this,"change",
a);steal.dev.log("Model.js - "+e.shortName+" "+a);c.trigger(e,a,this)}});var n=c.Model.List=c.Observe.List({setup:function(a){c.isPlainObject(a)&&!c.isArray(a)?(c.Observe.List.prototype.setup.apply(this),this.replace(this.constructor.Observe.findAll(a))):c.Observe.List.prototype.setup.apply(this,arguments)},_changes:function(a,b){c.Observe.List.prototype._changes.apply(this,arguments);if(/\w+\.destroyed/.test(b)){var e=this.indexOf(a.target);-1!=e&&this.splice(e,1)}}});return c.Model});